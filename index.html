 <!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* ... (पहले वाला <style> सेक्शन) ... */

        /* Login Page Styles */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c6bed; /* Telegram blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000; /* On top of everything */
            color: #fff;
            text-align: center;
        }

        /* ... (बाकी CSS) ... */
    </style>
</head>
<body>

    <section id="login-page">
        <h1>Welcome to VideoFire</h1>
        <p>Share your favorite videos, earn rewards, and discover new content!</p>
        <div class="telegram-login-wrapper">
            <h2>Login with Telegram</h2>
            <div id="telegram-login-widget">
                <script async src="https://telegram.org/js/telegram-widget.js?22"
                        data-telegram-login="Videofire_bot"  data-size="large"
                        data-onauth="onTelegramAuth(user)"
                        data-request-access="write">
                </script>
            </div>
            <p style="font-size: 14px; color: #666;">No account needed, just use your Telegram.</p>
        </div>
    </section>

    <div id="app-content" style="display: none;">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        import videojs from 'https://vjs.zencdn.net/8.10.0/video.min.js';

        // !!! WARNING: THIS BOT TOKEN IS EXPOSED CLIENT-SIDE. THIS IS A MAJOR SECURITY FLAW. !!!
        // !!! DO NOT USE THIS APPROACH IN PRODUCTION OR FOR SENSITIVE APPLICATIONS. !!!
        // The secure way requires a server-side component (like Firebase Cloud Functions)
        // to verify the Telegram hash and issue a Firebase Custom Token.
        const TELEGRAM_BOT_TOKEN_CLIENT_SIDE = "8125023086:AAH53bDbheT1QN49ELj9G-TVRUrVVlNt8CM"; // सुनिश्चित करें कि यह आपका सही API टोकन है

        const firebaseConfig = {
            apiKey: "AIzaSyDes3ioeygnWBqJB6NnHb7xj732JJhOqm8", // Replace with your actual Firebase API Key
            authDomain: "videofire-268ff.firebaseapp.com",
            databaseURL: "https://videofire-268ff-default-rtdb.firebaseio.com",
            projectId: "videofire-268ff",
            storageBucket: "videofire-268ff.firebasestorage.app",
            messagingSenderId: "910374058927",
            appId: "1:910374058927:web:6add3afdea07cfa29914d5a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUser = null;

        const VIEWS_FOR_WITHDRAWAL = 20000;
        const EARNING_PER_1000_VIEWS_MIN = 10;
        const TELEGRAM_CHANNEL_URL = 'https://t.me/Apknixyapp'; // Your Telegram channel for withdrawal

        // ... (पहले वाला UI Section Management) ...

        // --- Telegram Login Widget Integration (Client-Side HASH Verification - INSECURE) ---
        window.onTelegramAuth = async function(user) {
            alert('1. onTelegramAuth called. User ID: ' + user.id); // <-- NEW ALERT
            console.log('1. onTelegramAuth called with user data:', user);

            // Hash verification function (client-side)
            const checkHash = async (authData) => {
                const dataCheckArray = [];
                for (const key in authData) {
                    if (key !== 'hash' && key !== 'photo_url') {
                        dataCheckArray.push(`${key}=${authData[key]}`);
                    }
                }
                dataCheckArray.sort();
                const dataCheckString = dataCheckArray.join('\n');

                alert('2. Data Check String generated.'); // <-- NEW ALERT
                console.log('2. Data Check String for Hashing:', dataCheckString);

                const secretKey = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(TELEGRAM_BOT_TOKEN_CLIENT_SIDE));
                
                const hmacKey = await crypto.subtle.importKey(
                    'raw',
                    secretKey,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                const signature = await crypto.subtle.sign(
                    'HMAC',
                    hmacKey,
                    new TextEncoder().encode(dataCheckString)
                );

                const hexHash = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
                
                alert('3. Calculated Hash: ' + hexHash + '\nReceived Hash: ' + authData.hash); // <-- NEW ALERT
                console.log('3. Calculated Hash (Client-Side):', hexHash);
                console.log('4. Received Hash from Telegram:', authData.hash);
                
                return hexHash === authData.hash;
            };

            const isHashValid = await checkHash(user);
            alert('5. Is hash valid (client-side verification)? ' + isHashValid); // <-- NEW ALERT
            console.log('5. Is hash valid (client-side verification)?', isHashValid);
            
            if (!isHashValid) {
                alert('Login failed. Hash verification failed. Check bot token in code!'); // <-- NEW ALERT (more specific)
                console.error('Telegram hash verification failed (client-side). This might indicate tampering or an incorrect bot token in the code.');
                // alert('Login failed. Invalid data received from Telegram or incorrect bot token configured. Please check console for details.'); // Changed to simpler alert for mobile
                return;
            }

            // Optional: Check auth_date (for freshness). Recommended in production.
            const FIVE_MINUTES_IN_SECONDS = 300;
            const currentTimeInSeconds = Date.now() / 1000;
            if (user.auth_date < (currentTimeInSeconds - FIVE_MINUTES_IN_SECONDS)) {
                alert('Warning: Login data is old. Proceeding anyway.'); // <-- NEW ALERT
                console.warn('Telegram authentication data is older than 5 minutes. Consider re-authenticating for stronger security.');
            }

            const uid = `telegram_${user.id}`;
            currentUser = {
                uid: uid,
                telegramId: user.id,
                username: user.username || user.first_name || `TelegramUser_${user.id}`,
                profilePic: user.photo_url || `https://via.placeholder.com/40/2c6bed/ffffff?text=${user.first_name ? user.first_name.charAt(0) : 'U'}`,
                totalViews: 0,
                uploadedVideosCount: 0
            };
            alert('6. Hash is valid. Setting up currentUser object.'); // <-- NEW ALERT
            console.log('6. Hash is valid. Setting up currentUser object:', currentUser);

            try {
                const userRef = ref(database, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);

                if (!userSnapshot.exists()) {
                    await set(userRef, {
                        telegramId: currentUser.telegramId,
                        username: currentUser.username,
                        profilePic: currentUser.profilePic,
                        totalViews: 0,
                        uploadedVideosCount: 0,
                        createdAt: Date.now()
                    });
                    alert('7. New user data written to Firebase Realtime Database.'); // <-- NEW ALERT
                    console.log('7. New user data written to Firebase Realtime Database.');
                } else {
                    const userData = userSnapshot.val();
                    currentUser.totalViews = userData.totalViews || 0;
                    currentUser.uploadedVideosCount = userData.uploadedVideosCount || 0;
                    if (user.photo_url && userData.profilePic !== user.photo_url) {
                        await update(userRef, { profilePic: user.photo_url });
                        currentUser.profilePic = user.photo_url;
                        alert('8. Existing user data updated in Firebase (profile pic).'); // <-- NEW ALERT
                        console.log('8. Existing user data updated in Firebase Realtime Database (profile pic).');
                    } else {
                        alert('8. Existing user data loaded from Firebase.'); // <-- NEW ALERT
                        console.log('8. Existing user data loaded from Firebase, no profile pic update needed.');
                    }
                }

                alert('9. Attempting to update UI and show app content.'); // <-- NEW ALERT
                console.log('9. Attempting to update UI and show app content.');
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-profile-pic-topbar').src = currentUser.profilePic;

                loadHomeVideos();
                loadPopunderAd();
                updateProfileUI();
                alert('10. Login process completed successfully. Welcome to VideoFire!'); // <-- NEW ALERT
                console.log('10. Login process completed successfully. Welcome to VideoFire!');

            } catch (error) {
                alert("Error during Firebase operations (writing user data): " + error.message); // <-- NEW ALERT for Firebase errors
                console.error("Error during Firebase operations (writing user data):", error);
            }
        };

        // ... (बाकी का JavaScript कोड) ...
    </script>

</body>
</html>
