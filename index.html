 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoFire - Telegram Video Sharing</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        /* (Your CSS remains the same as before) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5; /* Light grey background */
            color: #333;
            line-height: 1.6;
            display: flex;
            min-height: 100vh; /* Full viewport height */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* --- Sidebar Navigation (Left) --- */
        .sidebar {
            width: 250px;
            background-color: #ffffff;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: fixed; /* Fixed sidebar */
            height: 100%;
            z-index: 100;
        }

        .sidebar-logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .sidebar-logo h1 {
            color: #2c6bed; /* Telegram-like blue */
            font-size: 28px;
            font-weight: 700;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
        }

        .sidebar-nav ul li a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #555;
            text-decoration: none;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar-nav ul li a i {
            margin-right: 15px;
            font-size: 20px;
            color: #777;
        }

        .sidebar-nav ul li a:hover,
        .sidebar-nav ul li a.active {
            background-color: #e0f2f7;
            color: #2c6bed;
        }
        .sidebar-nav ul li a:hover i,
        .sidebar-nav ul li a.active i {
            color: #2c6bed;
        }

        /* --- Main Content Area (Right) --- */
        .main-content {
            flex-grow: 1;
            margin-left: 250px; /* Space for the fixed sidebar */
            padding: 20px;
            position: relative;
        }

        /* --- Top Bar / Search Bar --- */
        .top-bar {
            background-color: #ffffff;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            position: sticky; /* Sticky top bar */
            top: 0;
            z-index: 50;
        }

        .search-bar {
            flex-grow: 1;
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px 12px 50px; /* Left padding for icon */
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-bar input:focus {
            border-color: #2c6bed;
        }

        .search-bar i {
            position: absolute;
            left: 20px;
            color: #999;
            font-size: 18px;
        }

        .user-profile-icon {
            margin-left: 20px;
            cursor: pointer;
            position: relative;
        }

        .user-profile-icon img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #2c6bed;
        }

        /* --- Home Section (Video Grid) --- */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive grid */
            gap: 25px;
            padding: 0 10px;
        }

        .video-card {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .video-thumbnail {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000; /* Placeholder background */
            overflow: hidden;
        }

        .video-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .video-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.3;
            max-height: 2.6em; /* Limit to 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-meta {
            font-size: 14px;
            color: #777;
            margin-bottom: 10px;
        }

        .video-author {
            display: flex;
            align-items: center;
            margin-top: auto; /* Push to bottom */
        }

        .video-author img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .video-author span {
            font-weight: 500;
            color: #555;
        }

        /* --- Upload Button (Center Bottom) --- */
        .upload-button-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
        }

        .upload-button {
            background-color: #2c6bed;
            color: #ffffff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 5px 15px rgba(44, 107, 237, 0.4);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .upload-button:hover {
            background-color: #205ac7;
            transform: translateY(-3px);
        }

        /* --- Upload Page (Hidden by default) --- */
        .upload-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .upload-form-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            animation: fadeInScale 0.3s ease-out;
            position: relative;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .upload-form-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c6bed;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s;
            resize: vertical; /* Allow textarea resizing */
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            border-color: #2c6bed;
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
        }

        .upload-submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #2c6bed;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .upload-submit-btn:hover {
            background-color: #205ac7;
        }

        .close-upload-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-upload-btn:hover {
            color: #555;
        }

        /* --- Profile Section (Hidden by default, similar structure to Upload Page) --- */
        .profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .profile-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px;
            animation: fadeInScale 0.3s ease-out;
            position: relative;
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling if content overflows */
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-header img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #2c6bed;
            margin-bottom: 15px;
        }

        .profile-header h2 {
            font-size: 32px;
            color: #333;
            margin-bottom: 5px;
        }

        .profile-header p {
            font-size: 16px;
            color: #777;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            text-align: center;
        }

        .stat-item {
            background-color: #f0f2f5;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
        }

        .stat-item h3 {
            font-size: 24px;
            color: #2c6bed;
            margin-bottom: 5px;
        }

        .stat-item p {
            font-size: 14px;
            color: #555;
        }

        .profile-videos-section {
            margin-top: 30px;
        }

        .profile-videos-section h3 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .profile-video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Reusing video-card styles for profile videos */

        .withdraw-section {
            background-color: #e6ffe6; /* Light green background */
            border: 1px solid #ccebcc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
        }

        .withdraw-section p {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }

        .withdraw-section span {
            font-weight: 700;
            color: #28a745; /* Green for target */
        }

        .withdraw-button {
            background-color: #28a745; /* Green for withdraw */
            color: #ffffff;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: none; /* Hidden by default, show when views met */
        }

        .withdraw-button:hover {
            background-color: #218838;
        }

        /* --- Ad Styles (Placeholders) --- */
        .ad-container {
            width: 100%;
            margin: 20px 0;
            text-align: center;
            background-color: #e9e9e9;
            padding: 15px;
            border-radius: 8px;
            color: #555;
            font-size: 14px;
        }

        /* Specific ad sizes/types */
        .banner-468x60 { max-width: 468px; height: 60px; background-color: #ccc; margin: 15px auto; display: flex; align-items: center; justify-content: center; }
        .banner-160x30 { max-width: 160px; height: 30px; background-color: #ccc; margin: 10px auto; display: flex; align-items: center; justify-content: center; }
        .banner-320x50 { max-width: 320px; height: 50px; background-color: #ccc; margin: 10px auto; display: flex; align-items: center; justify-content: center; }


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px; /* Collapse sidebar */
                align-items: center;
            }
            .sidebar-logo h1 {
                font-size: 0; /* Hide text */
            }
            .sidebar-nav ul li a {
                justify-content: center;
                padding: 15px 0;
            }
            .sidebar-nav ul li a span {
                display: none; /* Hide text labels */
            }
            .sidebar-nav ul li a i {
                margin-right: 0;
            }
            .main-content {
                margin-left: 80px;
            }
            .top-bar {
                padding: 10px 15px;
            }
            .search-bar input {
                padding: 10px 15px; /* Remove left padding for icon if icon is moved */
                padding-left: 45px; /* Adjust if icon is still there */
            }
            .search-bar i {
                left: 15px;
            }
            .user-profile-icon {
                margin-left: 10px;
            }
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 15px;
            }
            .upload-button-container {
                bottom: 20px;
                width: 100%;
                display: flex;
                justify-content: center;
            }
            .upload-button {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            .upload-form-container, .profile-container {
                width: 95%;
                padding: 25px;
            }
            .profile-stats {
                flex-direction: column;
            }
            .stat-item {
                margin: 10px 0;
            }
        }

        /* --- Login Page Styles --- */
        #login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c6bed; /* Telegram blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000; /* On top of everything */
            color: #fff;
            text-align: center;
        }

        #login-page h1 {
            font-size: 48px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        #login-page p {
            font-size: 20px;
            margin-bottom: 40px;
        }

        .telegram-login-wrapper {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .telegram-login-wrapper h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }

        /* --- Video Player Overlay (for VAST ad and Telegram embed) --- */
        #video-player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .video-player-container {
            position: relative;
            width: 90%;
            max-width: 900px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        #vast-ad-player {
            width: 100%;
            height: auto; /* Adjust based on video aspect ratio */
            display: block;
        }
        /* Make video.js player responsive */
        .video-js {
            width: 100% !important;
            height: auto !important;
        }

        #telegram-video-iframe {
            width: 100%;
            height: 500px; /* Adjust dynamically or use aspect ratio trick */
            border: none;
            display: none; /* Hidden until Telegram video is ready */
        }


        .close-player-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1501;
        }

        /* --- Footer (for popunder ad) --- */
        .footer-ad-placeholder {
            height: 1px; /* Minimal height */
            visibility: hidden; /* Hide visually but keep in DOM for popunder */
            overflow: hidden;
            pointer-events: none; /* Do not interfere with clicks */
        }

    </style>
</head>
<body>

    <section id="login-page">
        <h1>Welcome to VideoFire</h1>
        <p>Share your favorite videos, earn rewards, and discover new content!</p>
        <div class="telegram-login-wrapper">
            <h2>Login with Telegram</h2>
            <div id="telegram-login-widget">
                <script async src="https://telegram.org/js/telegram-widget.js?22"
                        data-telegram-login="Videofire_bot"  data-size="large"
                        data-onauth="onTelegramAuth(user)"
                        data-request-access="write">
                </script>
            </div>
            <p style="font-size: 14px; color: #666;">No account needed, just use your Telegram.</p>
        </div>
    </section>

    <div id="app-content" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <h1>VideoFire</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" class="active" onclick="showSection('home', event)"><i class="fas fa-home"></i> <span>Home</span></a></li>
                    <li><a href="#" onclick="showSection('profile', event)"><i class="fas fa-user"></i> <span>My Profile</span></a></li>
                    <li><a href="#" onclick="showSection('settings', event)"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                    <li><a href="#" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search videos by tags, description...">
                </div>
                <div class="user-profile-icon" onclick="showSection('profile', event)">
                    <img src="https://via.placeholder.com/40/2c6bed/ffffff?text=U" alt="User Profile" id="user-profile-pic-topbar">
                    </div>
            </header>

            <section id="home-section" class="video-grid">
                <div class="ad-container banner-468x60">
                    <p>Advertisement</p>
                    <script type="text/javascript">
                        atOptions = {
                            'key' : '7cc9b0386975c414c8ab9629f405b0dc',
                            'format' : 'iframe',
                            'height' : 60, /* Adjusted height for banner */
                            'width' : 468, /* Adjusted width for banner */
                            'params' : {}
                        };
                        // Note: If you put multiple of these, ensure they don't conflict or use an ad library
                        // document.write is generally not recommended after initial page load.
                        // You'd use createElement and appendChild for dynamic loading.
                        // document.write('<scr' + 'ipt type="text/javascript" src="//www.profitableprogram.com/7cc9b0386975c414c8ab9629f405b0dc/invoke.js"></scr' + 'ipt>');
                    </script>
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">AD SLOT</div>
                </div>
                </section>

            <section id="settings-section" style="display: none; padding: 20px;">
                <h2>Settings</h2>
                <p>App settings will be configured here.</p>
                </section>

        </main>

        <div class="upload-button-container">
            <div class="upload-button" onclick="showUploadPage()">
                <i class="fas fa-upload"></i>
            </div>
        </div>

        <section id="upload-page" class="upload-page">
            <div class="upload-form-container">
                <button class="close-upload-btn" onclick="hideUploadPage()">&times;</button>
                <h2>Upload Your Video</h2>
                <form id="video-upload-form">
                    <div class="form-group">
                        <label for="video-title">Video Title</label>
                        <input type="text" id="video-title" placeholder="Enter video title" required>
                    </div>
                    <div class="form-group">
                        <label for="video-link">Telegram Video Direct File Link</label>
                        <input type="text" id="video-link" placeholder="Paste direct .mp4 or .mkv link from Telegram channel/bot" required>
                        <small>
                            This must be a direct link to the video file itself (e.g., from a CDN or a bot that provides direct URLs).
                            Telegram doesn't provide easy embed URLs like YouTube.
                            You might need a Telegram Bot that uploads files to a cloud storage (like Firebase Storage or S3) and gives you a direct link.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="video-thumbnail-link">Video Thumbnail Link (Optional)</label>
                        <input type="text" id="video-thumbnail-link" placeholder="Paste direct image link for thumbnail (e.g., .jpg, .png)">
                        <small>A good thumbnail will attract more views.</small>
                    </div>
                    <div class="form-group">
                        <label for="video-tags">Tags (comma separated, max 300 characters)</label>
                        <input type="text" id="video-tags" placeholder="e.g., travel, vlog, india, mountains" maxlength="300">
                        <small>Separate tags with commas. Max 300 characters.</small>
                    </div>
                    <div class="form-group">
                        <label for="video-description">Description (max 400 words)</label>
                        <textarea id="video-description" placeholder="Describe your video..." maxlength="2400"></textarea> <small>Max 400 words.</small>
                    </div>
                    <button type="submit" class="upload-submit-btn">Upload Video</button>
                </form>
            </div>
        </section>

        <section id="profile-page" class="profile-page">
            <div class="profile-container">
                <button class="close-upload-btn" onclick="hideProfilePage()">&times;</button>
                <div class="profile-header">
                    <img src="https://via.placeholder.com/120/2c6bed/ffffff?text=U" alt="Profile Picture" id="profile-pic-main">
                    <h2 id="profile-username">Your Telegram Username</h2>
                    <p id="profile-telegram-id">@telegram_id_here</p>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <h3 id="profile-videos-count">0</h3>
                        <p>Videos Uploaded</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="profile-total-views">0</h3>
                        <p>Total Views</p>
                    </div>
                    <div class="stat-item">
                        <h3>₹ <span id="profile-estimated-earnings">0.00</span></h3>
                        <p>Estimated Earnings</p>
                    </div>
                </div>

                <div class="withdraw-section">
                    <p>Views for next withdrawal: <span id="views-countdown">20,000</span></p>
                    <button id="withdraw-button" class="withdraw-button">Withdraw Earnings</button>
                </div>

                <div class="profile-videos-section">
                    <h3>My Uploaded Videos</h3>
                    <div id="profile-video-grid" class="profile-video-grid">
                        </div>
                </div>
            </div>
        </section>

        <section id="video-player-overlay">
            <div class="video-player-container">
                <button class="close-player-btn" onclick="closeVideoPlayer()">&times;</button>

                <video id="vast-ad-player" class="video-js vjs-default-skin" controls preload="auto" data-setup='{}'>
                    </video>

                <iframe id="telegram-video-iframe" allowfullscreen></iframe>
            </div>
        </section>

    </div> <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        import videojs from 'https://vjs.zencdn.net/8.10.0/video.min.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDes3ioeygnWBqJB6NnHb7xj732JJhOqm8", // Replace with your actual Firebase API Key
            authDomain: "videofire-268ff.firebaseapp.com",
            databaseURL: "https://videofire-268ff-default-rtdb.firebaseio.com",
            projectId: "videofire-268ff",
            storageBucket: "videofire-268ff.firebasestorage.app",
            messagingSenderId: "910374058927",
            appId: "1:910374058927:web:6add3afdea07cfa29914d5a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUser = null;

        const VIEWS_FOR_WITHDRAWAL = 20000;
        const EARNING_PER_1000_VIEWS_MIN = 10;
        const TELEGRAM_CHANNEL_URL = 'https://t.me/Apknixyapp'; // Your Telegram channel for withdrawal

        // --- UI Section Management (Same as before) ---
        window.showSection = function(sectionId, event) {
            if (event) event.preventDefault();

            document.querySelectorAll('main section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById('upload-page').style.display = 'none';
            document.getElementById('profile-page').style.display = 'none';
            document.getElementById('video-player-overlay').style.display = 'none';

            if (sectionId === 'home') {
                document.getElementById('home-section').style.display = 'grid';
            } else if (sectionId === 'profile') {
                document.getElementById('profile-page').style.display = 'flex';
                loadUserProfileData();
            } else if (sectionId === 'settings') {
                document.getElementById('settings-section').style.display = 'block';
            }

            document.querySelectorAll('.sidebar-nav ul li a').forEach(link => {
                link.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                document.querySelector(`.sidebar-nav ul li a[onclick*="showSection('${sectionId}')"]`).classList.add('active');
            }
        };

        window.showUploadPage = function() {
            document.getElementById('upload-page').style.display = 'flex';
        };

        window.hideUploadPage = function() {
            document.getElementById('upload-page').style.display = 'none';
            document.getElementById('video-upload-form').reset();
        };

        window.hideProfilePage = function() {
            document.getElementById('profile-page').style.display = 'none';
        };

        window.closeVideoPlayer = function() {
            const player = videojs.getPlayer('vast-ad-player');
            if (player) {
                player.pause();
                player.dispose();
            }
            document.getElementById('telegram-video-iframe').src = '';
            document.getElementById('telegram-video-iframe').style.display = 'none';
            document.getElementById('video-player-overlay').style.display = 'none';
        };


        // --- Telegram Login Widget Integration ---
        // The script tag for the Telegram Login Widget is now directly in HTML.
        // So, we don't need a loadTelegramLoginWidget() function here.

        // This function is called by Telegram widget after successful login
        window.onTelegramAuth = async function(user) {
            console.log('Telegram User Authenticated:', user);

            const uid = `telegram_${user.id}`;
            let customToken = '';

            try {
                // IMPORTANT: Replace this with YOUR Firebase Cloud Function URL/Endpoint
                // Example for Netlify functions (or your Firebase Function HTTP endpoint):
                const response = await fetch('/.netlify/functions/verifyTelegramAuth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                const data = await response.json();
                if (data.firebaseToken) {
                    customToken = data.firebaseToken;
                } else {
                    console.error('Failed to get Firebase custom token:', data.error);
                    alert('Login failed. Please try again: ' + (data.error || 'Unknown error'));
                    return;
                }

                await signInWithCustomToken(auth, customToken);
                // Auth state change listener will handle the rest (UI changes)

            } catch (error) {
                console.error("Error during Telegram authentication process:", error);
                alert("An error occurred during login. Please try again.");
            }
        };

        // Firebase Auth State Listener (Same as before)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = {
                    uid: user.uid,
                    telegramId: user.providerData[0]?.uid || user.uid.replace('telegram_', ''),
                    username: user.displayName || `User_${user.uid.substring(0, 6)}`,
                    profilePic: user.photoURL || 'https://via.placeholder.com/40/2c6bed/ffffff?text=U'
                };
                console.log('Firebase User Signed In:', currentUser);

                const userRef = ref(database, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                if (!userSnapshot.exists()) {
                    await set(userRef, {
                        telegramId: currentUser.telegramId,
                        username: currentUser.username,
                        profilePic: currentUser.profilePic,
                        totalViews: 0,
                        uploadedVideosCount: 0,
                        createdAt: Date.now()
                    });
                } else {
                    const userData = userSnapshot.val();
                    currentUser.totalViews = userData.totalViews || 0;
                    currentUser.uploadedVideosCount = userData.uploadedVideosCount || 0;
                    if (user.photoURL && userData.profilePic !== user.photoURL) {
                        await update(userRef, { profilePic: user.photoURL });
                        currentUser.profilePic = user.photoURL;
                    }
                }

                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('user-profile-pic-topbar').src = currentUser.profilePic;

                loadHomeVideos();
                loadPopunderAd();
                updateProfileUI();
            } else {
                currentUser = null;
                console.log('Firebase User Signed Out.');
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
                // No need to clear/reload widget as it's directly in HTML
            }
        });

        window.handleLogout = async function(event) {
            if (event) event.preventDefault();
            try {
                await signOut(auth);
                alert('Logged out successfully.');
            } catch (error) {
                console.error("Error logging out:", error);
                alert("Failed to logout. Please try again.");
            }
        };

        // --- Firebase Data Handling (Same as before) ---

        function loadHomeVideos() {
            const videoGrid = document.getElementById('home-section');
            const existingAds = videoGrid.querySelector('.ad-container');
            videoGrid.innerHTML = '';
            if (existingAds) videoGrid.appendChild(existingAds);

            const videosRef = ref(database, 'videos');
            onValue(videosRef, (snapshot) => {
                const videos = [];
                snapshot.forEach(childSnapshot => {
                    const video = childSnapshot.val();
                    video.id = childSnapshot.key;
                    videos.push(video);
                });

                videos.sort((a, b) => b.uploadTimestamp - a.uploadTimestamp);

                videos.forEach(video => {
                    const thumbnailUrl = video.thumbnailLink || `https://via.placeholder.com/320x180/777777/FFFFFF?text=Video`;
                    const viewsText = video.views !== undefined ? video.views.toLocaleString() : '0';
                    const uploadDate = new Date(video.uploadTimestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                    const videoCard = `
                        <div class="video-card" data-video-id="${video.id}" data-video-link="${video.telegramLink}" data-video-thumbnail="${video.thumbnailUrl}" onclick="playVideoWrapper('${video.id}', '${video.telegramLink}')">
                            <div class="video-thumbnail">
                                <img src="${thumbnailUrl}" alt="${video.title}">
                            </div>
                            <div class="video-info">
                                <h4 class="video-title">${video.title}</h4>
                                <p class="video-meta">${viewsText} views • ${uploadDate}</p>
                                <div class="video-author">
                                    <img src="${video.uploaderProfilePic || 'https://via.placeholder.com/30/33C7FF/FFFFFF?text=U'}" alt="Author">
                                    <span>${video.uploaderUsername || 'Unknown User'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    videoGrid.insertAdjacentHTML('beforeend', videoCard);
                });
            }, {
                onlyOnce: false
            });
        }

        document.getElementById('video-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert('Please login to upload videos.');
                return;
            }

            const title = document.getElementById('video-title').value;
            const telegramLink = document.getElementById('video-link').value;
            const thumbnailLink = document.getElementById('video-thumbnail-link').value;
            const tags = document.getElementById('video-tags').value.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag.length > 0);
            const description = document.getElementById('video-description').value;

            if (!title || !telegramLink) {
                alert('Please enter video title and Telegram video link.');
                return;
            }

            if (!telegramLink.match(/\.(mp4|mkv|avi|mov)$/i)) {
                alert('Please provide a direct link to the video file (e.g., ending with .mp4, .mkv).');
                return;
            }

            try {
                const newVideoRef = push(ref(database, 'videos'));
                const videoData = {
                    title: title,
                    telegramLink: telegramLink,
                    thumbnailLink: thumbnailLink || '',
                    tags: tags,
                    description: description,
                    uploaderId: currentUser.uid,
                    uploaderUsername: currentUser.username,
                    uploaderProfilePic: currentUser.profilePic,
                    views: 0,
                    uploadTimestamp: Date.now()
                };
                await set(newVideoRef, videoData);

                const userRef = ref(database, `users/${currentUser.uid}`);
                await update(userRef, {
                    uploadedVideosCount: (currentUser.uploadedVideosCount || 0) + 1
                });
                currentUser.uploadedVideosCount = (currentUser.uploadedVideosCount || 0) + 1;
                updateProfileUI();

                alert('Video uploaded successfully!');
                hideUploadPage();
            } catch (error) {
                console.error("Error uploading video: ", error);
                alert('Failed to upload video. Please try again: ' + error.message);
            }
        });

        async function loadUserProfileData() {
            if (!currentUser) return;

            const userRef = ref(database, `users/${currentUser.uid}`);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentUser.totalViews = userData.totalViews || 0;
                    currentUser.uploadedVideosCount = userData.uploadedVideosCount || 0;
                    currentUser.username = userData.username || currentUser.username;
                    currentUser.profilePic = userData.profilePic || currentUser.profilePic;
                    updateProfileUI();
                }
            });

            const profileVideoGrid = document.getElementById('profile-video-grid');
            profileVideoGrid.innerHTML = '';

            const userVideosQuery = query(ref(database, 'videos'), orderByChild('uploaderId'), equalTo(currentUser.uid));
            onValue(userVideosQuery, (snapshot) => {
                profileVideoGrid.innerHTML = '';
                const userVideos = [];
                snapshot.forEach(childSnapshot => {
                    const video = childSnapshot.val();
                    video.id = childSnapshot.key;
                    userVideos.push(video);
                });

                userVideos.sort((a, b) => b.uploadTimestamp - a.uploadTimestamp);

                userVideos.forEach(video => {
                    const thumbnailUrl = video.thumbnailLink || `https://via.placeholder.com/320x180/ADD8E6/FFFFFF?text=My+Video`;
                    const viewsText = video.views !== undefined ? video.views.toLocaleString() : '0';
                    const uploadDate = new Date(video.uploadTimestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                    const videoCard = `
                        <div class="video-card" data-video-id="${video.id}" data-video-link="${video.telegramLink}" onclick="playVideoWrapper('${video.id}', '${video.telegramLink}')">
                            <div class="video-thumbnail">
                                <img src="${thumbnailUrl}" alt="${video.title}">
                            </div>
                            <div class="video-info">
                                <h4 class="video-title">${video.title}</h4>
                                <p class="video-meta">${viewsText} views • ${uploadDate}</p>
                            </div>
                        </div>
                    `;
                    profileVideoGrid.insertAdjacentHTML('beforeend', videoCard);
                });
            });
        }

        function updateProfileUI() {
            if (!currentUser) return;

            document.getElementById('profile-pic-main').src = currentUser.profilePic;
            document.getElementById('user-profile-pic-topbar').src = currentUser.profilePic;
            document.getElementById('profile-username').textContent = currentUser.username;
            document.getElementById('profile-telegram-id').textContent = `@${currentUser.username.toLowerCase().replace(/\s/g, '_')}`;

            document.getElementById('profile-videos-count').textContent = (currentUser.uploadedVideosCount || 0).toLocaleString();
            document.getElementById('profile-total-views').textContent = (currentUser.totalViews || 0).toLocaleString();

            const estimatedEarnings = ((currentUser.totalViews || 0) / 1000) * EARNING_PER_1000_VIEWS_MIN;
            document.getElementById('profile-estimated-earnings').textContent = estimatedEarnings.toFixed(2);

            const viewsRemaining = VIEWS_FOR_WITHDRAWAL - (currentUser.totalViews || 0);
            document.getElementById('views-countdown').textContent = viewsRemaining > 0 ? viewsRemaining.toLocaleString() : "0 (Eligible)";

            const withdrawButton = document.getElementById('withdraw-button');
            if ((currentUser.totalViews || 0) >= VIEWS_FOR_WITHDRAWAL) {
                withdrawButton.style.display = 'block';
            } else {
                withdrawButton.style.display = 'none';
            }
        }

        document.getElementById('withdraw-button').addEventListener('click', () => {
            if (!currentUser) {
                alert('Please login to withdraw earnings.');
                return;
            }

            if ((currentUser.totalViews || 0) >= VIEWS_FOR_WITHDRAWAL) {
                const confirmation = confirm(`Are you sure you want to withdraw your earnings? Your views (${(currentUser.totalViews || 0).toLocaleString()}) will be reset to 0 after manual verification.`);
                if (confirmation) {
                    alert('Your withdrawal request has been submitted! Please send a message to our Telegram channel with your details for verification: ' + TELEGRAM_CHANNEL_URL);
                    window.open(TELEGRAM_CHANNEL_URL, '_blank');
                }
            } else {
                alert(`You need ${VIEWS_FOR_WITHDRAWAL - (currentUser.totalViews || 0)} more views to withdraw.`);
            }
        });

        // --- Video Player (VAST Ad + Telegram Video) (Same as before) ---
        let player = null;

        window.playVideoWrapper = async function(videoId, telegramLink) {
            document.getElementById('video-player-overlay').style.display = 'flex';

            const vastAdPlayerElement = document.getElementById('vast-ad-player');
            if (player) {
                player.dispose();
            }
            player = videojs(vastAdPlayerElement, {
                autoplay: true,
                controls: true,
                sources: []
            });

            const vastAdUrl = 'https://s.magsrv.com/v1/vast.php?idzone=5609878';

            vastAdPlayerElement.style.display = 'block';
            document.getElementById('telegram-video-iframe').style.display = 'none';

            try {
                alert("Playing VAST Ad now... (This would be an actual video ad)");
                console.log('Fetching VAST Ad from:', vastAdUrl);
                await new Promise(resolve => setTimeout(resolve, 5000));

                vastAdPlayerElement.style.display = 'none';
                playTelegramVideo(videoId, telegramLink);

                incrementVideoViews(videoId);

            } catch (error) {
                console.error("Error playing VAST ad or getting VAST data:", error);
                alert("Failed to play ad. Proceeding to video.");
                vastAdPlayerElement.style.display = 'none';
                playTelegramVideo(videoId, telegramLink);
                incrementVideoViews(videoId);
            }
        };

        function playTelegramVideo(videoId, telegramLink) {
            const iframe = document.getElementById('telegram-video-iframe');
            iframe.src = telegramLink;
            iframe.style.display = 'block';
            console.log("Playing Telegram video:", telegramLink);
        }

        async function incrementVideoViews(videoId) {
            if (!currentUser) return;

            const videoRef = ref(database, `videos/${videoId}/views`);
            const userRef = ref(database, `users/${currentUser.uid}/totalViews`);

            try {
                const videoViewsSnapshot = await get(videoRef);
                let currentVideoViews = videoViewsSnapshot.val() || 0;
                await set(videoRef, currentVideoViews + 1);

                const userTotalViewsSnapshot = await get(userRef);
                let currentUserTotalViews = userTotalViewsSnapshot.val() || 0;
                await set(userRef, currentUserTotalViews + 1);

                currentUser.totalViews = currentUserTotalViews + 1;
                updateProfileUI();

                console.log(`Views for video ${videoId} and user ${currentUser.uid} incremented.`);
            } catch (error) {
                console.error("Error incrementing views: ", error);
            }
        }

        // --- Search Functionality (Same as before) ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const videoCards = document.querySelectorAll('#home-section .video-card');

            videoCards.forEach(card => {
                const title = card.querySelector('.video-title').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // --- Popunder Ad Integration (Same as before) ---
        function loadPopunderAd() {
            const popunderScript = document.createElement('script');
            popunderScript.type = 'text/javascript';
            popunderScript.innerHTML = `
                var url = "https://www.profitablegate.com/j48n8l2l?key=67f60700d866a4f5b5f25777b7f94119";
                var popunder = {
                    click: function() {
                        if (!localStorage.getItem('popunderSession')) {
                            window.open(url);
                            localStorage.setItem('popunderSession', 'true');
                        }
                    },
                    pop: function() {
                        if (!localStorage.getItem('popunderSession')) {
                            window.open(url, '_blank', 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=800, height=600');
                            localStorage.setItem('popunderSession', 'true');
                        }
                    }
                };
                document.body.addEventListener('click', popunder.click, { once: true });
            `;
            document.body.appendChild(popunderScript);
            console.log('Popunder ad script loaded.');
        }

        // --- Initial Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // No need to call loadTelegramLoginWidget() as it's directly in HTML now.
            // onAuthStateChanged will handle initial UI setup based on login status.
            // If the user is already logged in (e.g., from a previous session),
            // onAuthStateChanged will automatically show #app-content.
            // If not logged in, #login-page will remain visible with the widget.
        });

    </script>

</body>
</html>
