<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Auth Callback</title>
</head>
<body>
    <h1>Processing Telegram Login...</h1>
    <p id="auth-data-display"></p>

    <script type="module">
        // !!! WARNING: THIS BOT TOKEN IS EXPOSED CLIENT-SIDE. THIS IS A MAJOR SECURITY FLAW. !!!
        const TELEGRAM_BOT_TOKEN_CLIENT_SIDE = "8125023086:AAH53bDbheT1QN49ELj9G-TVRUrVVlNt8CM"; // तुम्हारा सही बॉट टोकन

        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
            });
            return params;
        }

        const authData = getQueryParams();
        const authDataDisplay = document.getElementById('auth-data-display');
        authDataDisplay.innerHTML = 'Received data: <pre>' + JSON.stringify(authData, null, 2) + '</pre>';

        const checkHash = async (data) => {
            const dataCheckArray = [];
            for (const key in data) {
                if (key !== 'hash' && key !== 'photo_url') {
                    dataCheckArray.push(`<span class="math-inline">\{key\}\=</span>{data[key]}`);
                }
            }
            dataCheckArray.sort();
            const dataCheckString = dataCheckArray.join('\n');

            const secretKey = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(TELEGRAM_BOT_TOKEN_CLIENT_SIDE));
            const hmacKey = await crypto.subtle.importKey(
                'raw',
                secretKey,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            const signature = await crypto.subtle.sign(
                'HMAC',
                hmacKey,
                new TextEncoder().encode(dataCheckString)
            );
            const hexHash = Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');

            return hexHash === data.hash;
        };

        async function processAuth() {
            if (authData.hash) {
                alert('Callback page: Received hash. Checking...');
                const isValid = await checkHash(authData);
                alert('Callback page: Hash valid? ' + isValid);

                if (isValid) {
                    alert('Login successful! Redirecting to main app...');
                    // यहाँ Firebase लॉगिन और रीडायरेक्शन तर्क आएगा
                    // उदाहरण के लिए, डेटा को localStorage में स्टोर करें और index.html पर वापस जाएं
                    localStorage.setItem('telegram_user_data', JSON.stringify(authData));
                    window.location.href = 'https://apknixy.github.io/'; // या सीधे index.html
                } else {
                    alert('Hash verification failed! Redirecting to login page.');
                    window.location.href = 'https://apknixy.github.io/'; // या सीधे index.html
                }
            } else {
                alert('No auth data received. Redirecting to login page.');
                window.location.href = 'https://apknixy.github.io/'; // या सीधे index.html
            }
        }

        processAuth();
    </script>
</body>
</html>
